#include <stdio.h>
#include "pico/stdlib.h"
#include "hardware/i2c.h"

// Dirección I2C de la pantalla SSD1306
#define SSD1306_I2C_ADDRESS 0x3C

// Dimensiones de la pantalla OLED
#define OLED_WIDTH 128
#define OLED_HEIGHT 64

// Dimensiones de la fuente
#define FONT_HEIGHT 8
#define FONT_BWIDTH 1

// Matriz de cada letra específica para "EDGAR OCLICA"
const char FONT_SELECTED[27][FONT_HEIGHT * FONT_BWIDTH] = {
    { 0xC0,0x38,0x26,0x38,0xC0,0x00,0x00,0x00 }, // A
    { 0xFE,0x92,0x92,0x92,0x6C,0x00,0x00,0x00 }, // B
    { 0x7C,0x82,0x82,0x82,0xC6,0x00,0x00,0x00 }, // C
    { 0xFE,0x82,0x82,0x44,0x38,0x00,0x00,0x00 }, // D
    { 0xFE,0x92,0x92,0x92,0x82,0x00,0x00,0x00 }, // E
    { 0xFE,0x12,0x12,0x12,0x02,0x00,0x00,0x00 }, // F
    { 0x7C,0x82,0x82,0x92,0xF4,0x00,0x00,0x00 }, // G
    { 0xFE,0x10,0x10,0x10,0xFE,0x00,0x00,0x00 }, // H
    { 0x00,0x82,0xFE,0x82,0x00,0x00,0x00,0x00 }, // I
    { 0x80,0x80,0x82,0x82,0x7E,0x00,0x00,0x00 }, // J
    { 0xFE,0x10,0x28,0x44,0x82,0x00,0x00,0x00 }, // K
    { 0xFE,0x80,0x80,0x80,0xC0,0x00,0x00,0x00 }, // L
    { 0xFE,0x18,0x60,0x18,0xFE,0x00,0x00,0x00 }, // M
    { 0xFE,0x06,0x38,0xC0,0xFE,0x00,0x00,0x00 }, // N
    { 0x7C,0x82,0x82,0x82,0x7C,0x00,0x00,0x00 }, // O
    { 0xFE,0x12,0x12,0x12,0x0C,0x00,0x00,0x00 }, // P
    { 0x7C,0x82,0xA2,0x42,0xBC,0x00,0x00,0x00 }, // Q
    { 0xFE,0x12,0x12,0x12,0xEC,0x00,0x00,0x00 }, // R
    { 0x4C,0x92,0x92,0x92,0x64,0x00,0x00,0x00 }, // S
    { 0x02,0x02,0xFE,0x02,0x02,0x00,0x00,0x00 }, // T
    { 0x7E,0x80,0x80,0x80,0x7E,0x00,0x00,0x00 }, // U
    { 0x0E,0x30,0xC0,0x30,0x0E,0x00,0x00,0x00 }, // V
    { 0x1E,0xE0,0x1C,0xE0,0x1E,0x00,0x00,0x00 }, // W
    { 0xC6,0x28,0x10,0x28,0xC6,0x00,0x00,0x00 }, // X
    { 0x0E,0x10,0xF0,0x10,0x0E,0x00,0x00,0x00 }, // Y
    { 0xC6,0xA2,0x92,0x8A,0xC6,0x00,0x00,0x00 }, // Z
    { 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 }, // ESPACIO
};

// Inicialización de la pantalla SSD1306
void oled_init() {
    uint8_t init_sequence[] = {
        0xAE, 0x20, 0x00, 0xB0, 0xC8, 0x00, 0x10, 0x40, 0x81, 0xFF,
        0xA1, 0xA6, 0xA8, 0x3F, 0xA4, 0xD3, 0x00, 0xD5, 0x80, 0xD9,
        0xF1, 0xDA, 0x12, 0xDB, 0x40, 0x8D, 0x14, 0xAF
    };
    for (int i = 0; i < sizeof(init_sequence); i++) {
        uint8_t data[2] = {0x00, init_sequence[i]};
        i2c_write_blocking(i2c_default, SSD1306_I2C_ADDRESS, data, 2, false);
    }
}

// Limpia el buffer de pantalla
void oled_clear() {
    for (int page = 0; page < 8; page++) {
        uint8_t buffer[129];
        buffer[0] = 0x40; // Indicador de datos
        for (int i = 1; i < 129; i++) {
            buffer[i] = 0x00;
        }
        i2c_write_blocking(i2c_default, SSD1306_I2C_ADDRESS, buffer, 129, false);
    }
}

// Dibuja un carácter en una posición específica
void oled_draw_character(int index, int x) {
    uint8_t data[FONT_HEIGHT + 1];
    data[0] = 0x40; // Indicador de datos
    for (int i = 0; i < FONT_HEIGHT; i++) {
        data[i + 1] = FONT_SELECTED[index][i];
    }
    i2c_write_blocking(i2c_default, SSD1306_I2C_ADDRESS, data, FONT_HEIGHT + 1, false);
}

// Muestra un texto basado en un arreglo de índices
void oled_display_text(const int *indices, int length) {
    int x = 0;
    for (int i = 0; i < length; i++) {
        oled_draw_character(indices[i], x);
        x += 8; // Avanza 8 píxeles entre caracteres
    }
}

int main() {
    stdio_init_all();
    i2c_init(i2c_default, 100 * 1000);
    gpio_set_function(PICO_DEFAULT_I2C_SDA_PIN, GPIO_FUNC_I2C);
    gpio_set_function(PICO_DEFAULT_I2C_SCL_PIN, GPIO_FUNC_I2C);
    gpio_pull_up(PICO_DEFAULT_I2C_SDA_PIN);
    gpio_pull_up(PICO_DEFAULT_I2C_SCL_PIN);

    // Inicialización y escritura en pantalla
    oled_init();
    oled_clear();

    int name_indices[] = {4, 3, 6, 0, 17, 26, 14, 2, 11, 8, 2, 0}; // "EDGAR OCLICA"
    oled_display_text(name_indices, sizeof(name_indices) / sizeof(name_indices[0]));

    while (true) {
        // Bucle principal vacío
    }
}
